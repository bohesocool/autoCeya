# 🛡️ 请求频率限制说明

## ❓ 常见误解

> **"我是测压软件，RPM可能上万，为什么要限制请求频率？"**

这是一个常见的误解！让我详细解释：

---

## 🎯 频率限制的真实作用

### ✅ 它限制什么？

请求频率限制（Rate Limiting）**仅限制用户访问控制面板的 API 请求**，包括：

| API 端点 | 说明 | 是否受限制 |
|---------|------|-----------|
| `POST /api/login` | 用户登录 | ✅ 受限制 |
| `POST /api/start` | 启动测试 | ✅ 受限制 |
| `POST /api/stop` | 停止测试 | ✅ 受限制 |
| `GET /api/status` | 查询状态 | ✅ 受限制 |
| `GET /api/history` | 查询历史 | ✅ 受限制 |
| `DELETE /api/history/:id` | 删除记录 | ✅ 受限制 |

### ❌ 它不限制什么？

**测压功能发送给 AI 模型的请求完全不受影响！**

```javascript
// 这些请求不受频率限制影响：
stressTestService.aiService.execute(prompt)  // ← 直接发送给 Gemini/OpenAI/Claude
// 可以达到几万 RPM 都没问题！
```

---

## 🔍 技术实现

### 代码架构

```
用户浏览器
    ↓
    ↓ 访问控制台API（如登录、启动测试）
    ↓
[限流中间件]  ← 在这里检查频率（100次/分钟）
    ↓
[API 路由层]
    ↓
[控制器层]
    ↓
[服务层] → stressTestService
              ↓
              ↓ 测压请求（绕过限流中间件）
              ↓
          [直接发送] → AI 模型（Gemini/OpenAI/Claude）
                         ↑
                         └─ 可以达到几万 RPM！
```

### 中间件应用位置

```javascript
// server-new.js

// 限流中间件只应用在 /api/ 路由上
app.use('/api/', rateLimitMiddleware);  // ← 只限制控制台API

// 测压服务内部的请求不经过这个中间件
// src/services/stressTestService.js
async executeRequest() {
  const result = await this.aiService.execute(prompt);  // ← 直接发送，不受限制
}
```

---

## 🛡️ 为什么需要这个限制？

### 保护控制面板免受攻击

1. **防止暴力破解登录密码**
   ```
   攻击者尝试：
   - 尝试 password123 ❌
   - 尝试 password456 ❌
   - 尝试 password789 ❌
   - ... 第 101 次 → 被拒绝 🛡️
   ```

2. **防止恶意频繁操作**
   ```
   恶意用户：
   - 频繁启动/停止测试
   - 疯狂查询历史记录
   - DoS 攻击控制面板
   → 超过限制后被拦截 🛡️
   ```

3. **保护系统资源**
   - 防止数据库被频繁查询
   - 防止 WebSocket 连接被滥用
   - 保护服务器 CPU/内存

---

## ⚙️ 配置说明

### 默认配置

```bash
# .env
RATE_LIMIT_MAX=100        # 每分钟最多 100 次控制台API请求
RATE_LIMIT_WINDOW=1       # 时间窗口 1 分钟
```

### 配置建议

| 使用场景 | 推荐配置 | 说明 |
|---------|---------|------|
| 个人使用 | 100/分钟 | 默认配置，完全够用 |
| 小团队 | 200-500/分钟 | 多人同时使用 |
| 生产环境 | 1000/分钟 | 更宽松的限制 |
| 完全禁用 | 99999/分钟 | 基本等于不限制 |

### 如何调整

```bash
# 1. 编辑 .env 文件
RATE_LIMIT_MAX=500        # 改为 500 次/分钟

# 2. 重启服务
npm start
```

---

## 📊 实际使用示例

### 场景 1：正常使用（不会触发限制）

```
用户操作：
1. 登录系统                    → 1次请求
2. 启动测试                    → 1次请求
3. 查看状态（每30秒刷新）      → 2次请求/分钟
4. 查看历史记录                → 1次请求

总计：约 5 次/分钟  ✅ 远低于 100 次限制
```

**同时测压可以发送几万个请求给 AI 模型！**

### 场景 2：异常使用（会触发限制）

```
恶意脚本：
for i in range(200):
    requests.post('/api/login', data={'password': f'test{i}'})

结果：
- 前 100 次：正常处理
- 第 101 次开始：返回 429 Too Many Requests ⛔
```

---

## 🔧 如何完全禁用限制？

如果你确实不需要这个保护，可以：

### 方法 1：设置极高的限制（推荐）

```bash
# .env
RATE_LIMIT_MAX=999999
```

### 方法 2：修改代码注释掉限流中间件

```javascript
// server-new.js

// 请求频率限制（仅限制控制面板API，不影响测压功能）
// app.use('/api/', rateLimitMiddleware);  // ← 注释掉这行
```

### 方法 3：使用环境变量控制

我可以帮你添加一个开关：

```bash
# .env
ENABLE_RATE_LIMIT=false  # 设为 false 禁用
```

需要我实现这个功能吗？

---

## 📈 监控和调试

### 查看限制信息

每次 API 请求的响应头都会包含限制信息：

```http
HTTP/1.1 200 OK
X-RateLimit-Limit: 100           ← 总限制数
X-RateLimit-Remaining: 95        ← 剩余次数
X-RateLimit-Reset: 2025-11-07... ← 重置时间
```

### 被限制时的响应

```json
HTTP/1.1 429 Too Many Requests

{
  "success": false,
  "error": "请求过于频繁，请稍后再试",
  "retryAfter": 45  // 45秒后可重试
}
```

### 查看日志

```bash
# 查看限流日志
tail -f logs/combined.log | grep "请求频率超限"
```

---

## 💡 总结

| 项目 | 说明 |
|-----|------|
| **限制对象** | 仅限制控制面板 API（登录、管理等） |
| **不限制** | 测压功能发送给 AI 模型的请求 |
| **测压性能** | 可以达到几万 RPM，不受影响 |
| **默认配置** | 100 次/分钟（个人使用完全够） |
| **可否禁用** | 可以，设置极高值或修改代码 |
| **主要目的** | 保护系统免受暴力破解和 DoS 攻击 |

---

## ❓ 还有疑问？

如果你还有任何疑问，请随时提出！我可以：

1. ✅ 帮你调整限制配置
2. ✅ 添加开关功能（完全禁用/启用）
3. ✅ 修改限制策略（按用户而非 IP）
4. ✅ 添加白名单功能

---

**记住：这个限制只是为了保护你的控制面板安全，完全不会影响测压功能！** 🚀

