<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCeya - å®šæ—¶ä»»åŠ¡ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 20px;
            color: #667eea;
        }

        .schedule-list {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .list-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-bottom: 1px solid #e0e0e0;
        }

        .list-header h2 {
            font-size: 18px;
            color: #667eea;
        }

        .schedule-item {
            padding: 20px 30px;
            border-bottom: 1px solid #f0f0f0;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 180px;
            gap: 20px;
            align-items: center;
            transition: all 0.3s;
        }

        .schedule-item:hover {
            background: #f8f9fa;
        }

        .schedule-item:last-child {
            border-bottom: none;
        }

        .item-section {
            display: flex;
            flex-direction: column;
        }

        .item-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .item-value {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .item-value.primary {
            color: #667eea;
            font-size: 16px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-enabled {
            background: #d4edda;
            color: #155724;
        }

        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .type-once {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-recurring {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #667eea;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #999;
            font-size: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mode-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .mode-option.active {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .mode-option:hover {
            border-color: #667eea;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin: 25px 0 15px 0;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #667eea;
            font-size: 18px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading::before {
            content: "â³";
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @media (max-width: 1200px) {
            .schedule-item {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .item-section {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>â° å®šæ—¶ä»»åŠ¡ç®¡ç†</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="goBack()">è¿”å›æ§åˆ¶å°</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h2 class="page-title">å®šæ—¶ä»»åŠ¡åˆ—è¡¨</h2>
            <button class="btn btn-primary" onclick="openCreateModal()">â• åˆ›å»ºä»»åŠ¡</button>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #667eea;">
            <div style="font-size: 14px; color: #555;">
                <strong style="color: #667eea;">ğŸ’¡ æç¤ºï¼š</strong>
                <span>å®šæ—¶ä»»åŠ¡å¯ä»¥åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨æ‰§è¡Œå‹åŠ›æµ‹è¯•ã€‚æ”¯æŒä¸€æ¬¡æ€§æ‰§è¡Œå’Œé‡å¤æ‰§è¡Œï¼ˆCron è¡¨è¾¾å¼ï¼‰ä¸¤ç§æ¨¡å¼ã€‚</span>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="schedule-list">
            <div class="list-header">
                <h2>ä»»åŠ¡åˆ—è¡¨</h2>
            </div>
            <div id="scheduleContainer">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">åˆ›å»ºå®šæ—¶ä»»åŠ¡</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <input type="hidden" id="scheduleId">
                    
                    <div class="form-group">
                        <label>ä»»åŠ¡åç§° *</label>
                        <input type="text" id="scheduleName" placeholder="è¾“å…¥ä»»åŠ¡åç§°" required>
                    </div>

                    <div class="form-group">
                        <label>ä»»åŠ¡æè¿°</label>
                        <textarea id="scheduleDescription" placeholder="è¾“å…¥ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>

                    <h3 class="section-title">â° è°ƒåº¦é…ç½®</h3>
                    
                    <div class="mode-selector" id="scheduleTypeSelector">
                        <div class="mode-option active" data-type="once">
                            <div style="font-size: 18px; margin-bottom: 5px;">ğŸ“… ä¸€æ¬¡æ€§æ‰§è¡Œ</div>
                            <div style="font-size: 13px; color: #666;">åœ¨æŒ‡å®šæ—¶é—´æ‰§è¡Œä¸€æ¬¡</div>
                        </div>
                        <div class="mode-option" data-type="recurring">
                            <div style="font-size: 18px; margin-bottom: 5px;">ğŸ”„ é‡å¤æ‰§è¡Œ</div>
                            <div style="font-size: 13px; color: #666;">æŒ‰ Cron è¡¨è¾¾å¼å‘¨æœŸæ‰§è¡Œ</div>
                        </div>
                    </div>

                    <div id="onceConfig">
                        <div class="form-group">
                            <label>æ‰§è¡Œæ—¶é—´ *</label>
                            <input type="datetime-local" id="runAt" required>
                            <small>é€‰æ‹©ä»»åŠ¡æ‰§è¡Œçš„å…·ä½“æ—¶é—´</small>
                        </div>
                    </div>

                    <div id="recurringConfig" style="display: none;">
                        <div class="form-group">
                            <label>Cron è¡¨è¾¾å¼ *</label>
                            <input type="text" id="cronExpression" placeholder="ä¾‹å¦‚: */5 * * * * (æ¯5åˆ†é’Ÿ)">
                            <small>
                                æ ¼å¼: åˆ† æ—¶ æ—¥ æœˆ å‘¨ | 
                                ç¤ºä¾‹: <code>0 9 * * *</code> (æ¯å¤©9ç‚¹), 
                                <code>*/30 * * * *</code> (æ¯30åˆ†é’Ÿ), 
                                <code>0 0 * * 1</code> (æ¯å‘¨ä¸€0ç‚¹)
                            </small>
                        </div>
                    </div>

                    <h3 class="section-title">ğŸ”§ æµ‹è¯•é…ç½®</h3>

                    <div class="form-group">
                        <label>AI æä¾›å•† *</label>
                        <select id="providerType">
                            <option value="gemini">Gemini (Google)</option>
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="claude">Claude (Anthropic)</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>æµ‹è¯•ç«™ç‚¹ URL *</label>
                            <input type="text" id="testUrl" placeholder="https://api.example.com" required>
                        </div>
                        <div class="form-group">
                            <label>æ¨¡å‹åç§° *</label>
                            <input type="text" id="modelName" placeholder="gemini-1.5-flash" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>API å¯†é’¥ *</label>
                        <input type="password" id="apiKey" placeholder="your-api-key" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>è¯·æ±‚ç±»å‹</label>
                            <select id="requestType">
                                <option value="stream">æµå¼è¯·æ±‚</option>
                                <option value="non-stream">éæµå¼è¯·æ±‚</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æµ‹å‹æ¨¡å¼</label>
                            <select id="testMode">
                                <option value="fixed">å›ºå®šæµ‹å‹</option>
                                <option value="auto">è‡ªåŠ¨æµ‹å‹</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ç›®æ ‡ RPM</label>
                            <input type="number" id="rpm" value="60" min="1" max="100000">
                        </div>
                        <div class="form-group">
                            <label>æµ‹è¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="testDuration" value="5" min="1" max="1440">
                            <small>å»ºè®®è®¾ç½®åˆç†çš„æµ‹è¯•æ—¶é•¿</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æµ‹è¯•è¯­å¥</label>
                        <textarea id="testPrompt" placeholder="è¾“å…¥æµ‹è¯•è¯­å¥">è¯·ç®€å•ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†ç¨‹</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveSchedule()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentScheduleType = 'once';
        let editingScheduleId = null;

        // éªŒè¯ç™»å½•
        if (!authToken) {
            window.location.href = '/';
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadSchedules();
            initScheduleTypeSelector();
            setDefaultRunAt();
        });

        // è®¾ç½®é»˜è®¤æ‰§è¡Œæ—¶é—´ï¼ˆå½“å‰æ—¶é—´ + 1å°æ—¶ï¼‰
        function setDefaultRunAt() {
            const now = new Date();
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
            now.setSeconds(0);
            const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('runAt').value = localISOTime;
        }

        // åˆå§‹åŒ–è°ƒåº¦ç±»å‹é€‰æ‹©å™¨
        function initScheduleTypeSelector() {
            const options = document.querySelectorAll('#scheduleTypeSelector .mode-option');
            options.forEach(option => {
                option.addEventListener('click', () => {
                    options.forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    currentScheduleType = option.dataset.type;
                    updateScheduleTypeUI();
                });
            });
        }

        // æ›´æ–°è°ƒåº¦ç±»å‹ UI
        function updateScheduleTypeUI() {
            const onceConfig = document.getElementById('onceConfig');
            const recurringConfig = document.getElementById('recurringConfig');
            
            if (currentScheduleType === 'once') {
                onceConfig.style.display = 'block';
                recurringConfig.style.display = 'none';
            } else {
                onceConfig.style.display = 'none';
                recurringConfig.style.display = 'block';
            }
        }

        // åŠ è½½å®šæ—¶ä»»åŠ¡åˆ—è¡¨
        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const result = await response.json();
                renderSchedules(result.data);
            } catch (error) {
                document.getElementById('scheduleContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <div>åŠ è½½å¤±è´¥: ${error.message}</div>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderSchedules(schedules) {
            const container = document.getElementById('scheduleContainer');
            
            if (!schedules || schedules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div>æš‚æ— å®šæ—¶ä»»åŠ¡</div>
                        <div style="margin-top: 10px; color: #999; font-size: 14px;">ç‚¹å‡»"åˆ›å»ºä»»åŠ¡"æŒ‰é’®æ·»åŠ æ–°çš„å®šæ—¶ä»»åŠ¡</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = schedules.map(schedule => {
                const statusClass = schedule.enabled ? 'status-enabled' : 'status-disabled';
                const statusText = schedule.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                const typeClass = schedule.schedule_type === 'once' ? 'type-once' : 'type-recurring';
                const typeText = schedule.schedule_type === 'once' ? 'ä¸€æ¬¡æ€§' : 'é‡å¤æ‰§è¡Œ';
                
                // è§£ææµ‹è¯•é…ç½®
                let testConfig = {};
                try {
                    testConfig = typeof schedule.test_config === 'string' 
                        ? JSON.parse(schedule.test_config) 
                        : schedule.test_config;
                } catch (e) {
                    testConfig = {};
                }

                const nextRunText = schedule.next_run_at 
                    ? formatDateTime(new Date(schedule.next_run_at))
                    : '-';
                const lastRunText = schedule.last_run_at 
                    ? formatDateTime(new Date(schedule.last_run_at))
                    : 'ä»æœªæ‰§è¡Œ';

                return `
                    <div class="schedule-item">
                        <div class="item-section">
                            <span class="item-label">ä»»åŠ¡åç§°</span>
                            <span class="item-value primary">${escapeHtml(schedule.name)}</span>
                            <div style="margin-top: 5px;">
                                <span class="type-badge ${typeClass}">${typeText}</span>
                                <span class="status-badge ${statusClass}" style="margin-left: 5px;">${statusText}</span>
                            </div>
                        </div>
                        <div class="item-section">
                            <span class="item-label">è°ƒåº¦é…ç½®</span>
                            <span class="item-value">${schedule.schedule_type === 'once' 
                                ? formatDateTime(new Date(schedule.run_at))
                                : schedule.cron_expression}</span>
                        </div>
                        <div class="item-section">
                            <span class="item-label">ä¸‹æ¬¡æ‰§è¡Œ</span>
                            <span class="item-value">${nextRunText}</span>
                        </div>
                        <div class="item-section">
                            <span class="item-label">ä¸Šæ¬¡æ‰§è¡Œ</span>
                            <span class="item-value">${lastRunText}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn ${schedule.enabled ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleSchedule(${schedule.id})">
                                ${schedule.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="action-btn btn-primary" onclick="editSchedule(${schedule.id})">ç¼–è¾‘</button>
                            <button class="action-btn btn-danger" onclick="deleteSchedule(${schedule.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ‰“å¼€åˆ›å»ºæ¨¡æ€æ¡†
        function openCreateModal() {
            editingScheduleId = null;
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºå®šæ—¶ä»»åŠ¡';
            document.getElementById('scheduleForm').reset();
            setDefaultRunAt();
            
            // é‡ç½®è°ƒåº¦ç±»å‹
            currentScheduleType = 'once';
            const options = document.querySelectorAll('#scheduleTypeSelector .mode-option');
            options.forEach(o => o.classList.remove('active'));
            options[0].classList.add('active');
            updateScheduleTypeUI();
            
            document.getElementById('scheduleModal').classList.add('active');
        }

        // ç¼–è¾‘ä»»åŠ¡
        async function editSchedule(id) {
            try {
                const response = await fetch(`/api/schedules/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥');
                }

                const result = await response.json();
                const schedule = result.data;
                
                editingScheduleId = id;
                document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å®šæ—¶ä»»åŠ¡';
                
                // å¡«å……è¡¨å•
                document.getElementById('scheduleName').value = schedule.name;
                document.getElementById('scheduleDescription').value = schedule.description || '';
                
                // è®¾ç½®è°ƒåº¦ç±»å‹
                currentScheduleType = schedule.schedule_type;
                const options = document.querySelectorAll('#scheduleTypeSelector .mode-option');
                options.forEach(o => {
                    o.classList.remove('active');
                    if (o.dataset.type === currentScheduleType) {
                        o.classList.add('active');
                    }
                });
                updateScheduleTypeUI();

                if (schedule.schedule_type === 'once' && schedule.run_at) {
                    const runAt = new Date(schedule.run_at);
                    const localISOTime = new Date(runAt.getTime() - runAt.getTimezoneOffset() * 60000)
                        .toISOString()
                        .slice(0, 16);
                    document.getElementById('runAt').value = localISOTime;
                }
                
                if (schedule.schedule_type === 'recurring') {
                    document.getElementById('cronExpression').value = schedule.cron_expression || '';
                }
                
                // å¡«å……æµ‹è¯•é…ç½®
                let testConfig = {};
                try {
                    testConfig = typeof schedule.test_config === 'string' 
                        ? JSON.parse(schedule.test_config) 
                        : schedule.test_config;
                } catch (e) {
                    testConfig = {};
                }
                
                document.getElementById('providerType').value = testConfig.providerType || 'gemini';
                document.getElementById('testUrl').value = testConfig.url || '';
                document.getElementById('modelName').value = testConfig.modelName || '';
                document.getElementById('apiKey').value = testConfig.apiKey || '';
                document.getElementById('requestType').value = testConfig.requestType || 'stream';
                document.getElementById('testMode').value = testConfig.mode || 'fixed';
                document.getElementById('rpm').value = testConfig.rpm || 60;
                document.getElementById('testDuration').value = testConfig.testDuration || 5;
                document.getElementById('testPrompt').value = testConfig.testPrompt || '';
                
                document.getElementById('scheduleModal').classList.add('active');
            } catch (error) {
                alert('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('scheduleModal').classList.remove('active');
            editingScheduleId = null;
        }

        // ä¿å­˜ä»»åŠ¡
        async function saveSchedule() {
            const name = document.getElementById('scheduleName').value.trim();
            const description = document.getElementById('scheduleDescription').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
                return;
            }

            // æ„å»ºè°ƒåº¦é…ç½®
            let scheduleConfig = {
                name,
                description,
                scheduleType: currentScheduleType,
            };

            if (currentScheduleType === 'once') {
                const runAt = document.getElementById('runAt').value;
                if (!runAt) {
                    alert('è¯·é€‰æ‹©æ‰§è¡Œæ—¶é—´');
                    return;
                }
                scheduleConfig.runAt = new Date(runAt).toISOString();
            } else {
                const cronExpression = document.getElementById('cronExpression').value.trim();
                if (!cronExpression) {
                    alert('è¯·è¾“å…¥ Cron è¡¨è¾¾å¼');
                    return;
                }
                scheduleConfig.cronExpression = cronExpression;
            }

            // æ„å»ºæµ‹è¯•é…ç½®
            const testUrl = document.getElementById('testUrl').value.trim();
            const modelName = document.getElementById('modelName').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!testUrl || !modelName || !apiKey) {
                alert('è¯·å¡«å†™å®Œæ•´çš„æµ‹è¯•é…ç½®ï¼ˆURLã€æ¨¡å‹åç§°ã€APIå¯†é’¥ï¼‰');
                return;
            }

            scheduleConfig.testConfig = {
                url: testUrl,
                modelName,
                apiKey,
                providerType: document.getElementById('providerType').value,
                requestType: document.getElementById('requestType').value,
                mode: document.getElementById('testMode').value,
                rpm: parseInt(document.getElementById('rpm').value) || 60,
                testDuration: parseInt(document.getElementById('testDuration').value) || 5,
                testPrompt: document.getElementById('testPrompt').value.trim() || 'è¯·ç®€å•ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½',
            };

            try {
                const url = editingScheduleId 
                    ? `/api/schedules/${editingScheduleId}` 
                    : '/api/schedules';
                const method = editingScheduleId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(scheduleConfig)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }

                closeModal();
                loadSchedules();
                alert(editingScheduleId ? 'ä»»åŠ¡æ›´æ–°æˆåŠŸ' : 'ä»»åŠ¡åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢ä»»åŠ¡çŠ¶æ€
        async function toggleSchedule(id) {
            try {
                const response = await fetch(`/api/schedules/${id}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'æ“ä½œå¤±è´¥');
                }

                loadSchedules();
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteSchedule(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®šæ—¶ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'åˆ é™¤å¤±è´¥');
                }

                loadSchedules();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(date) {
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è¿”å›æ§åˆ¶å°
        function goBack() {
            window.location.href = '/dashboard';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('scheduleModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });
    </script>

    <!-- ç‰ˆæœ¬å· -->
    <footer style="text-align: center; padding: 20px; color: #999; font-size: 12px; margin-top: 30px;">
        AutoCeya v2.1.1 | AI å‹åŠ›æµ‹è¯•å·¥å…·
    </footer>
</body>
</html>
