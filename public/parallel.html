<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCeya - å¹¶è¡Œæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 20px;
            color: #667eea;
        }

        .tip-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .tip-box strong {
            color: #667eea;
        }

        .config-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
        }

        .config-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .config-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            position: relative;
        }

        .config-card.active {
            border-color: #667eea;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .config-number {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }

        .remove-config-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .remove-config-btn:hover {
            background: #c0392b;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 13px;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group small {
            color: #999;
            font-size: 11px;
            margin-top: 4px;
        }

        .add-config-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }

        .add-config-btn:hover:not(:disabled) {
            background: #219a52;
        }

        .add-config-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .control-buttons .btn {
            padding: 14px 30px;
            font-size: 16px;
        }

        /* çŠ¶æ€å±•ç¤ºåŒºåŸŸ */
        .status-section {
            display: none;
        }

        .status-section.active {
            display: block;
        }

        .status-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-info {
            display: flex;
            align-items: center;
            font-size: 16px;
            font-weight: 500;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-stopped {
            background: #95a5a6;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .test-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .test-card-header {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }

        .test-status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .test-status-running {
            background: #d4edda;
            color: #155724;
        }

        .test-status-completed {
            background: #cce5ff;
            color: #004085;
        }

        .test-status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .test-status-stopped {
            background: #fff3cd;
            color: #856404;
        }

        .test-status-pending {
            background: #e2e3e5;
            color: #383d41;
        }

        .test-card-body {
            padding: 20px;
        }

        .test-config-info {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .test-config-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .test-config-label {
            color: #999;
        }

        .test-config-value {
            font-weight: 500;
            color: #333;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .test-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .test-stat-item {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .test-stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .test-stat-label {
            font-size: 12px;
            color: #999;
        }

        .success { color: #27ae60; }
        .danger { color: #e74c3c; }
        .warning { color: #f39c12; }
        .primary { color: #667eea; }

        /* å¯¹æ¯”è§†å›¾ */
        .comparison-section {
            display: none;
        }

        .comparison-section.active {
            display: block;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .comparison-table th {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .comparison-table tr:hover {
            background: #f8f9fa;
        }

        .comparison-table tr.best-row {
            background: #d4edda;
        }

        .comparison-table tr.worst-row {
            background: #f8d7da;
        }

        .best-badge {
            background: #27ae60;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }

        .worst-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .test-cards-grid {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ”€ å¹¶è¡Œæµ‹è¯•</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="goBack()">è¿”å›æ§åˆ¶å°</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- æç¤ºä¿¡æ¯ -->
        <div class="tip-box">
            <div style="font-size: 14px; color: #555;">
                <strong>ğŸ’¡ æç¤ºï¼š</strong>
                <span>å¹¶è¡Œæµ‹è¯•å…è®¸åŒæ—¶æµ‹è¯•å¤šä¸ª API ç«¯ç‚¹ï¼ˆæœ€å¤š 5 ä¸ªï¼‰ï¼Œæ–¹ä¾¿å¯¹æ¯”ä¸åŒé…ç½®æˆ–ä¸åŒæä¾›å•†çš„æ€§èƒ½ã€‚æµ‹è¯•å®Œæˆåå¯æŸ¥çœ‹å¯¹æ¯”ç»“æœã€‚</span>
            </div>
        </div>

        <!-- é…ç½®åŒºåŸŸ -->
        <div class="config-section" id="configSection">
            <h2 class="section-title">ğŸ“‹ æµ‹è¯•é…ç½®</h2>
            
            <div class="config-list" id="configList">
                <!-- é…ç½®å¡ç‰‡å°†é€šè¿‡ JS åŠ¨æ€æ·»åŠ  -->
            </div>

            <button class="add-config-btn" id="addConfigBtn" onclick="addConfig()">
                â• æ·»åŠ é…ç½®
            </button>

            <div class="control-buttons">
                <button class="btn btn-primary" id="startBtn" onclick="startParallelTest()">
                    ğŸš€ å¼€å§‹å¹¶è¡Œæµ‹è¯•
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopParallelTest()" disabled>
                    â¹ åœæ­¢æµ‹è¯•
                </button>
            </div>
        </div>

        <!-- çŠ¶æ€å±•ç¤ºåŒºåŸŸ -->
        <div class="status-section" id="statusSection">
            <div class="status-bar">
                <div class="status-info">
                    <span class="status-indicator status-stopped" id="statusIndicator"></span>
                    <span id="statusText">å‡†å¤‡å°±ç»ª</span>
                </div>
                <div id="totalTimer" style="font-size: 20px; font-weight: 700; color: #667eea;">
                    è¿è¡Œæ—¶é—´: 00:00:00
                </div>
            </div>

            <h2 class="section-title">ğŸ“Š å®æ—¶çŠ¶æ€</h2>
            <div class="test-cards-grid" id="testCardsGrid">
                <!-- æµ‹è¯•çŠ¶æ€å¡ç‰‡å°†é€šè¿‡ JS åŠ¨æ€æ·»åŠ  -->
            </div>
        </div>

        <!-- å¯¹æ¯”è§†å›¾ -->
        <div class="comparison-section" id="comparisonSection">
            <div class="config-section">
                <h2 class="section-title">ğŸ“ˆ ç»“æœå¯¹æ¯”</h2>
                <table class="comparison-table" id="comparisonTable">
                    <thead>
                        <tr>
                            <th>é…ç½®</th>
                            <th>æ¨¡å‹</th>
                            <th>æä¾›å•†</th>
                            <th>æ€»è¯·æ±‚</th>
                            <th>æˆåŠŸç‡</th>
                            <th>å¹³å‡å“åº”æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody">
                        <!-- å¯¹æ¯”æ•°æ®å°†é€šè¿‡ JS åŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let authToken = localStorage.getItem('authToken');
        let ws = null;
        let configs = [];
        let isRunning = false;
        let timerInterval = null;
        let startTime = null;
        const MAX_CONFIGS = 5;

        // éªŒè¯ç™»å½•
        if (!authToken) {
            window.location.href = '/';
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            addConfig(); // æ·»åŠ ç¬¬ä¸€ä¸ªé…ç½®
            connectWebSocket();
            checkCurrentStatus();
        });

        // è¿æ¥ WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                console.log('WebSocket å·²è¿æ¥');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onclose = () => {
                console.log('WebSocket å·²æ–­å¼€ï¼Œ3ç§’åé‡è¿...');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket é”™è¯¯:', error);
            };
        }

        // å¤„ç† WebSocket æ¶ˆæ¯
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'parallelTestStarted':
                    handleTestStarted(message.data);
                    break;
                case 'parallelTestUpdate':
                    handleTestUpdate(message.data);
                    break;
                case 'parallelTestStopped':
                    handleTestStopped(message.data);
                    break;
                case 'parallelTestAllCompleted':
                    handleAllCompleted(message.data);
                    break;
            }
        }

        // æ£€æŸ¥å½“å‰çŠ¶æ€
        async function checkCurrentStatus() {
            try {
                const response = await fetch('/api/parallel/status', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.data && result.data.isRunning) {
                        handleTestStarted(result.data);
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ·»åŠ é…ç½®
        function addConfig() {
            if (configs.length >= MAX_CONFIGS) {
                alert(`æœ€å¤šåªèƒ½æ·»åŠ  ${MAX_CONFIGS} ä¸ªé…ç½®`);
                return;
            }

            const configId = Date.now();
            configs.push({ id: configId });
            renderConfigs();
            updateAddButton();
        }

        // åˆ é™¤é…ç½®
        function removeConfig(configId) {
            if (configs.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªé…ç½®');
                return;
            }

            configs = configs.filter(c => c.id !== configId);
            renderConfigs();
            updateAddButton();
        }

        // æ›´æ–°æ·»åŠ æŒ‰é’®çŠ¶æ€
        function updateAddButton() {
            const btn = document.getElementById('addConfigBtn');
            btn.disabled = configs.length >= MAX_CONFIGS;
            btn.textContent = configs.length >= MAX_CONFIGS 
                ? `å·²è¾¾ä¸Šé™ (${MAX_CONFIGS}ä¸ª)` 
                : `â• æ·»åŠ é…ç½® (${configs.length}/${MAX_CONFIGS})`;
        }

        // æ¸²æŸ“é…ç½®åˆ—è¡¨
        function renderConfigs() {
            const container = document.getElementById('configList');
            container.innerHTML = configs.map((config, index) => `
                <div class="config-card" id="config-${config.id}">
                    <div class="config-header">
                        <span class="config-number">é…ç½® ${index + 1}</span>
                        ${configs.length > 1 ? `
                            <button class="remove-config-btn" onclick="removeConfig(${config.id})">
                                âŒ åˆ é™¤
                            </button>
                        ` : ''}
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>AI æä¾›å•† *</label>
                            <select id="provider-${config.id}" onchange="updateProviderHints(${config.id})">
                                <option value="gemini">Gemini (Google)</option>
                                <option value="openai">OpenAI (GPT)</option>
                                <option value="claude">Claude (Anthropic)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æµ‹è¯•ç«™ç‚¹ URL *</label>
                            <input type="text" id="url-${config.id}" placeholder="https://generativelanguage.googleapis.com">
                            <small id="urlHint-${config.id}"></small>
                        </div>
                        <div class="form-group">
                            <label>æ¨¡å‹åç§° *</label>
                            <input type="text" id="model-${config.id}" placeholder="gemini-1.5-flash">
                            <small id="modelHint-${config.id}"></small>
                        </div>
                        <div class="form-group">
                            <label>API å¯†é’¥ *</label>
                            <input type="password" id="apiKey-${config.id}" placeholder="your-api-key">
                        </div>
                        <div class="form-group">
                            <label>è¯·æ±‚ç±»å‹</label>
                            <select id="requestType-${config.id}">
                                <option value="stream">æµå¼è¯·æ±‚</option>
                                <option value="non-stream">éæµå¼è¯·æ±‚</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç›®æ ‡ RPM</label>
                            <input type="number" id="rpm-${config.id}" value="60" min="1" max="100000">
                        </div>
                        <div class="form-group">
                            <label>æµ‹è¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="duration-${config.id}" value="5" min="1" max="1440">
                            <small>0 = ä¸é™æ—¶</small>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>æµ‹è¯•è¯­å¥</label>
                            <input type="text" id="prompt-${config.id}" value="è¯·ç®€å•ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†ç¨‹" placeholder="è¾“å…¥æµ‹è¯•è¯­å¥">
                        </div>
                    </div>
                </div>
            `).join('');

            // åˆå§‹åŒ–æç¤º
            configs.forEach(config => {
                updateProviderHints(config.id);
            });
        }

        // æ›´æ–°æä¾›å•†æç¤º
        function updateProviderHints(configId) {
            const provider = document.getElementById(`provider-${configId}`).value;
            const urlHint = document.getElementById(`urlHint-${configId}`);
            const modelHint = document.getElementById(`modelHint-${configId}`);
            const urlInput = document.getElementById(`url-${configId}`);
            const modelInput = document.getElementById(`model-${configId}`);

            const hints = {
                gemini: {
                    url: 'https://generativelanguage.googleapis.com',
                    model: 'gemini-1.5-flash, gemini-1.5-pro',
                    urlPlaceholder: 'https://generativelanguage.googleapis.com',
                    modelPlaceholder: 'gemini-1.5-flash'
                },
                openai: {
                    url: 'https://api.openai.com',
                    model: 'gpt-4, gpt-3.5-turbo',
                    urlPlaceholder: 'https://api.openai.com',
                    modelPlaceholder: 'gpt-3.5-turbo'
                },
                claude: {
                    url: 'https://api.anthropic.com',
                    model: 'claude-3-opus, claude-3-sonnet',
                    urlPlaceholder: 'https://api.anthropic.com',
                    modelPlaceholder: 'claude-3-sonnet-20240229'
                }
            };

            const hint = hints[provider];
            urlHint.textContent = `ç¤ºä¾‹: ${hint.url}`;
            modelHint.textContent = `ç¤ºä¾‹: ${hint.model}`;
            urlInput.placeholder = hint.urlPlaceholder;
            modelInput.placeholder = hint.modelPlaceholder;
        }

        // æ”¶é›†é…ç½®æ•°æ®
        function collectConfigs() {
            return configs.map((config, index) => {
                const url = document.getElementById(`url-${config.id}`).value.trim();
                const modelName = document.getElementById(`model-${config.id}`).value.trim();
                const apiKey = document.getElementById(`apiKey-${config.id}`).value.trim();
                const providerType = document.getElementById(`provider-${config.id}`).value;
                const requestType = document.getElementById(`requestType-${config.id}`).value;
                const rpm = parseInt(document.getElementById(`rpm-${config.id}`).value) || 60;
                const testDuration = parseInt(document.getElementById(`duration-${config.id}`).value) || 0;
                const testPrompt = document.getElementById(`prompt-${config.id}`).value.trim();

                if (!url || !modelName || !apiKey) {
                    throw new Error(`é…ç½® ${index + 1}: è¯·å¡«å†™å®Œæ•´çš„ URLã€æ¨¡å‹åç§°å’Œ API å¯†é’¥`);
                }

                return {
                    url,
                    modelName,
                    apiKey,
                    providerType,
                    requestType,
                    rpm,
                    testDuration,
                    testPrompt: testPrompt || 'è¯·ç®€å•ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†ç¨‹',
                    promptMode: 'fixed'
                };
            });
        }

        // å¯åŠ¨å¹¶è¡Œæµ‹è¯•
        async function startParallelTest() {
            try {
                const testConfigs = collectConfigs();

                const response = await fetch('/api/parallel/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ configs: testConfigs })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'å¯åŠ¨å¤±è´¥');
                }

                handleTestStarted(result.data);
            } catch (error) {
                alert('å¯åŠ¨å¹¶è¡Œæµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // åœæ­¢å¹¶è¡Œæµ‹è¯•
        async function stopParallelTest() {
            try {
                const response = await fetch('/api/parallel/stop', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'åœæ­¢å¤±è´¥');
                }

                handleTestStopped(result.data);
            } catch (error) {
                alert('åœæ­¢å¹¶è¡Œæµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // å¤„ç†æµ‹è¯•å¯åŠ¨
        function handleTestStarted(data) {
            isRunning = true;
            startTime = new Date(data.startTime);

            // æ›´æ–° UI çŠ¶æ€
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('configSection').style.display = 'none';
            document.getElementById('statusSection').classList.add('active');
            document.getElementById('comparisonSection').classList.remove('active');

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            document.getElementById('statusIndicator').className = 'status-indicator status-running';
            document.getElementById('statusText').textContent = 'å¹¶è¡Œæµ‹è¯•è¿è¡Œä¸­...';

            // å¯åŠ¨è®¡æ—¶å™¨
            startTimer();

            // æ¸²æŸ“æµ‹è¯•å¡ç‰‡
            renderTestCards(data.tests);
        }

        // å¤„ç†æµ‹è¯•æ›´æ–°
        function handleTestUpdate(data) {
            updateTestCard(data.testId, data.stats, data.status);
        }

        // å¤„ç†æµ‹è¯•åœæ­¢
        function handleTestStopped(data) {
            isRunning = false;
            stopTimer();

            // æ›´æ–° UI çŠ¶æ€
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('statusIndicator').className = 'status-indicator status-stopped';
            document.getElementById('statusText').textContent = 'æµ‹è¯•å·²åœæ­¢';

            // æ›´æ–°æµ‹è¯•å¡ç‰‡
            if (data && data.tests) {
                data.tests.forEach(test => {
                    updateTestCard(test.testId, test.stats, test.status);
                });
            }

            // æ˜¾ç¤ºå¯¹æ¯”è§†å›¾
            showComparisonView(data);
        }

        // å¤„ç†æ‰€æœ‰æµ‹è¯•å®Œæˆ
        function handleAllCompleted(data) {
            isRunning = false;
            stopTimer();

            // æ›´æ–° UI çŠ¶æ€
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('statusIndicator').className = 'status-indicator status-stopped';
            document.getElementById('statusText').textContent = 'æ‰€æœ‰æµ‹è¯•å·²å®Œæˆ';

            // æ›´æ–°æµ‹è¯•å¡ç‰‡
            if (data && data.tests) {
                data.tests.forEach(test => {
                    updateTestCard(test.testId, test.stats, test.status);
                });
            }

            // æ˜¾ç¤ºå¯¹æ¯”è§†å›¾
            showComparisonView(data);
        }

        // å¯åŠ¨è®¡æ—¶å™¨
        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                if (!startTime) return;
                const elapsed = Date.now() - startTime.getTime();
                const seconds = Math.floor(elapsed / 1000) % 60;
                const minutes = Math.floor(elapsed / 60000) % 60;
                const hours = Math.floor(elapsed / 3600000);
                document.getElementById('totalTimer').textContent = 
                    `è¿è¡Œæ—¶é—´: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        // åœæ­¢è®¡æ—¶å™¨
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // æ¸²æŸ“æµ‹è¯•å¡ç‰‡
        function renderTestCards(tests) {
            const container = document.getElementById('testCardsGrid');
            container.innerHTML = tests.map((test, index) => `
                <div class="test-card" id="card-${test.testId}">
                    <div class="test-card-header">
                        <span class="test-card-title">æµ‹è¯• ${index + 1}: ${test.config.modelName}</span>
                        <span class="test-status-badge test-status-${test.status}" id="status-badge-${test.testId}">
                            ${getStatusText(test.status)}
                        </span>
                    </div>
                    <div class="test-card-body">
                        <div class="test-config-info">
                            <div class="test-config-item">
                                <span class="test-config-label">æä¾›å•†</span>
                                <span class="test-config-value">${getProviderName(test.config.providerType)}</span>
                            </div>
                            <div class="test-config-item">
                                <span class="test-config-label">URL</span>
                                <span class="test-config-value" title="${test.config.url}">${test.config.url}</span>
                            </div>
                            <div class="test-config-item">
                                <span class="test-config-label">ç›®æ ‡ RPM</span>
                                <span class="test-config-value">${test.config.rpm || '-'}</span>
                            </div>
                        </div>
                        <div class="test-stats-grid">
                            <div class="test-stat-item">
                                <div class="test-stat-value primary" id="total-${test.testId}">${test.stats.totalRequests}</div>
                                <div class="test-stat-label">æ€»è¯·æ±‚</div>
                            </div>
                            <div class="test-stat-item">
                                <div class="test-stat-value success" id="success-rate-${test.testId}">${test.stats.successRate}%</div>
                                <div class="test-stat-label">æˆåŠŸç‡</div>
                            </div>
                            <div class="test-stat-item">
                                <div class="test-stat-value warning" id="avg-time-${test.testId}">${test.stats.avgResponseTime}ms</div>
                                <div class="test-stat-label">å¹³å‡å“åº”</div>
                            </div>
                            <div class="test-stat-item">
                                <div class="test-stat-value primary" id="rpm-${test.testId}">${test.stats.currentRPM}</div>
                                <div class="test-stat-label">å½“å‰ RPM</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°æµ‹è¯•å¡ç‰‡
        function updateTestCard(testId, stats, status) {
            // æ›´æ–°çŠ¶æ€å¾½ç« 
            const statusBadge = document.getElementById(`status-badge-${testId}`);
            if (statusBadge) {
                statusBadge.className = `test-status-badge test-status-${status}`;
                statusBadge.textContent = getStatusText(status);
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const totalEl = document.getElementById(`total-${testId}`);
            const successRateEl = document.getElementById(`success-rate-${testId}`);
            const avgTimeEl = document.getElementById(`avg-time-${testId}`);
            const rpmEl = document.getElementById(`rpm-${testId}`);

            if (totalEl) totalEl.textContent = stats.totalRequests;
            if (successRateEl) successRateEl.textContent = `${stats.successRate}%`;
            if (avgTimeEl) avgTimeEl.textContent = `${stats.avgResponseTime}ms`;
            if (rpmEl) rpmEl.textContent = stats.currentRPM;
        }

        // æ˜¾ç¤ºå¯¹æ¯”è§†å›¾
        function showComparisonView(data) {
            if (!data || !data.tests || data.tests.length === 0) return;

            document.getElementById('comparisonSection').classList.add('active');

            const tests = data.tests;
            
            // æ‰¾å‡ºæœ€ä½³å’Œæœ€å·®é…ç½®ï¼ˆåŸºäºæˆåŠŸç‡ï¼‰
            let bestIndex = 0;
            let worstIndex = 0;
            tests.forEach((test, index) => {
                if (test.stats.successRate > tests[bestIndex].stats.successRate) {
                    bestIndex = index;
                }
                if (test.stats.successRate < tests[worstIndex].stats.successRate) {
                    worstIndex = index;
                }
            });

            // æ¸²æŸ“å¯¹æ¯”è¡¨æ ¼
            const tbody = document.getElementById('comparisonBody');
            tbody.innerHTML = tests.map((test, index) => {
                let rowClass = '';
                let badge = '';
                
                if (tests.length > 1) {
                    if (index === bestIndex) {
                        rowClass = 'best-row';
                        badge = '<span class="best-badge">æœ€ä½³</span>';
                    } else if (index === worstIndex) {
                        rowClass = 'worst-row';
                        badge = '<span class="worst-badge">æœ€å·®</span>';
                    }
                }

                return `
                    <tr class="${rowClass}">
                        <td>é…ç½® ${index + 1}${badge}</td>
                        <td>${test.config.modelName}</td>
                        <td>${getProviderName(test.config.providerType)}</td>
                        <td>${test.stats.totalRequests}</td>
                        <td>${test.stats.successRate}%</td>
                        <td>${test.stats.avgResponseTime}ms</td>
                        <td>
                            <span class="test-status-badge test-status-${test.status}">
                                ${getStatusText(test.status)}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…ä¸­',
                'running': 'è¿è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'stopped': 'å·²åœæ­¢'
            };
            return statusMap[status] || status;
        }

        // è·å–æä¾›å•†åç§°
        function getProviderName(providerType) {
            const providerMap = {
                'gemini': 'Gemini',
                'openai': 'OpenAI',
                'claude': 'Claude'
            };
            return providerMap[providerType] || providerType;
        }

        // è¿”å›æ§åˆ¶å°
        function goBack() {
            window.location.href = '/dashboard';
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    <!-- ç‰ˆæœ¬å· -->
    <footer style="text-align: center; padding: 20px; color: #999; font-size: 12px; margin-top: 30px;">
        AutoCeya <span id="app-version">v2.1.1</span> | AI å‹åŠ›æµ‹è¯•å·¥å…·
    </footer>
    <script>
        // åŠ¨æ€è·å–ç‰ˆæœ¬å·
        fetch('/api/version').then(r => r.json()).then(d => {
            document.getElementById('app-version').textContent = 'v' + d.version;
        }).catch(() => {});
    </script>
</body>
</html>
