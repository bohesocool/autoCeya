<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCeya - æµ‹å‹æ§åˆ¶å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .config-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #555;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 300px;
            line-height: 1.5;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mode-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .mode-option.active {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .mode-option:hover {
            border-color: #667eea;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #999;
            font-size: 14px;
        }

        .success { color: #27ae60; }
        .danger { color: #e74c3c; }
        .warning { color: #f39c12; }
        .primary { color: #667eea; }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .error-logs {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .log-item {
            padding: 12px;
            background: #fff5f5;
            border-left: 4px solid #e74c3c;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .log-time {
            color: #999;
            font-size: 12px;
            margin-right: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-stopped {
            background: #95a5a6;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .error-summary {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .error-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-message {
            flex: 1;
            margin-right: 15px;
            word-break: break-word;
        }

        .error-count {
            background: #e74c3c;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .request-logs {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .request-log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .request-log-table th {
            background: #f8f9fa;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        .request-log-table td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }

        .request-log-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.failure {
            background: #f8d7da;
            color: #721c24;
        }

        .error-detail {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            word-break: break-word;
        }

        .clear-logs-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            float: right;
            margin-bottom: 15px;
        }

        .clear-logs-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            margin: 0;
        }

        .status-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-info {
            display: flex;
            align-items: center;
            font-size: 16px;
            font-weight: 500;
        }

        .prompt-list {
            margin-top: 10px;
        }

        .prompt-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-start;
        }

        .prompt-item input {
            flex: 1;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add {
            background: #27ae60;
            color: white;
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
        }

        .btn-add:hover, .btn-remove:hover {
            opacity: 0.8;
        }

        small {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .control-buttons {
                flex-direction: column;
            }

            .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸš€ AutoCeya - æµ‹å‹æ§åˆ¶å°</h1>
            <div style="display: flex; gap: 15px;">
                <button class="logout-btn" onclick="viewHistory()">ğŸ“Š å†å²è®°å½•</button>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-info">
                <span class="status-indicator status-stopped" id="statusIndicator"></span>
                <span id="statusText">å‡†å¤‡å°±ç»ª</span>
            </div>
            <div id="currentRPM" style="font-size: 20px; font-weight: 700; color: #667eea;">
                å½“å‰ RPM: 0
            </div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #667eea;">
            <div style="font-size: 14px; color: #555;">
                <strong style="color: #667eea;">ğŸ’¡ æç¤ºï¼š</strong>
                <span>æµ‹å‹ä»»åŠ¡åœ¨æœåŠ¡å™¨åå°è¿è¡Œï¼Œå³ä½¿å…³é—­æµè§ˆå™¨çª—å£ï¼Œæµ‹è¯•ä¹Ÿä¼šç»§ç»­è¿›è¡Œã€‚é‡æ–°æ‰“å¼€é¡µé¢åå¯ä»¥çœ‹åˆ°æµ‹è¯•è¿›åº¦å’Œå®æ—¶æ•°æ®ã€‚é…ç½®ä¿¡æ¯å·²è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ã€‚</span>
            </div>
        </div>

        <!-- é…ç½®åŒºåŸŸ -->
        <div class="config-section">
            <h2 class="section-title">æµ‹è¯•é…ç½®</h2>
            
            <!-- AI æä¾›å•†é€‰æ‹© -->
            <h3 style="margin: 25px 0 15px 0; font-size: 16px; font-weight: 600;">â­ AI æä¾›å•†é€‰æ‹©ï¼ˆv2.0æ–°å¢ï¼‰</h3>
            <div class="form-group">
                <label>é€‰æ‹© AI æä¾›å•† *</label>
                <select id="providerType" onchange="updateProviderHints()">
                    <option value="gemini">Gemini (Google)</option>
                    <option value="openai">OpenAI (GPT)</option>
                    <option value="claude">Claude (Anthropic)</option>
                </select>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>æµ‹è¯•ç«™ç‚¹URL *</label>
                    <input type="text" id="url" placeholder="https://generativelanguage.googleapis.com">
                    <small id="urlHint" style="color: #999; font-size: 12px; margin-top: 5px;"></small>
                </div>
                
                <div class="form-group">
                    <label>æ¨¡å‹åç§° *</label>
                    <input type="text" id="modelName" placeholder="gemini-1.5-flash">
                    <small id="modelHint" style="color: #999; font-size: 12px; margin-top: 5px;"></small>
                </div>
                
                <div class="form-group">
                    <label>APIå¯†é’¥ *</label>
                    <input type="password" id="apiKey" placeholder="your-api-key">
                    <small id="apiKeyHint" style="color: #999; font-size: 12px; margin-top: 5px;"></small>
                </div>
            </div>

            <h3 style="margin: 25px 0 15px 0; font-size: 16px; font-weight: 600;">è¯·æ±‚ç±»å‹</h3>
            <div class="mode-selector" id="requestTypeSelector">
                <div class="mode-option active" data-type="stream">
                    <div style="font-size: 18px; margin-bottom: 5px;">ğŸŒŠ æµå¼è¯·æ±‚</div>
                    <div style="font-size: 13px; color: #666;">streamGenerateContent</div>
                </div>
                <div class="mode-option" data-type="non-stream">
                    <div style="font-size: 18px; margin-bottom: 5px;">âš¡ éæµå¼è¯·æ±‚</div>
                    <div style="font-size: 13px; color: #666;">generateContent</div>
                </div>
            </div>

            <h3 style="margin: 25px 0 15px 0; font-size: 16px; font-weight: 600;">æµ‹è¯•è¯­å¥æ¨¡å¼</h3>
            <div class="mode-selector" id="promptModeSelector">
                <div class="mode-option active" data-mode="fixed">
                    <div style="font-size: 18px; margin-bottom: 5px;">ğŸ“ å›ºå®šè¯­å¥</div>
                    <div style="font-size: 13px; color: #666;">ä½¿ç”¨ç›¸åŒçš„æµ‹è¯•è¯­å¥</div>
                </div>
                <div class="mode-option" data-mode="random">
                    <div style="font-size: 18px; margin-bottom: 5px;">ğŸ² éšæœºè¯­å¥</div>
                    <div style="font-size: 13px; color: #666;">éšæœºå˜åŒ–é¿å…é£æ§</div>
                </div>
            </div>

            <div class="form-group" id="fixedPromptGroup">
                <label>æµ‹è¯•è¯­å¥ * (æ”¯æŒå¤§æ–‡æœ¬ï¼Œæœ€å¤š200K)</label>
                <textarea id="testPrompt" placeholder="è¾“å…¥æµ‹è¯•è¯­å¥...&#10;&#10;æ”¯æŒé•¿æ–‡æœ¬è¾“å…¥ï¼Œæœ€å¤š200,000å­—ç¬¦&#10;å¯ç”¨äºæµ‹è¯•å¤§å‹è¾“å…¥çš„å¤„ç†èƒ½åŠ›"></textarea>
                <small>å½“å‰å­—ç¬¦æ•°: <span id="charCount">0</span> / 200,000</small>
            </div>

            <div class="form-group" id="randomPromptGroup" style="display: none;">
                <label>éšæœºæµ‹è¯•è¯­å¥åº“</label>
                <small>å·²é¢„è®¾10æ¡æµ‹è¯•è¯­å¥ï¼Œä½ å¯ä»¥ä¿®æ”¹æˆ–æ·»åŠ æ›´å¤šã€‚ç³»ç»Ÿä¼šéšæœºé€‰æ‹©å¹¶åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œå˜åŒ–</small>
                <div class="prompt-list" id="promptList">
                    <div class="prompt-item">
                        <input type="text" value="è¯·è¯¦ç»†åˆ†æäººå·¥æ™ºèƒ½åœ¨åŒ»ç–—å¥åº·é¢†åŸŸçš„åº”ç”¨å‰æ™¯å’Œæ½œåœ¨æŒ‘æˆ˜ï¼ŒåŒ…æ‹¬è¯Šæ–­è¾…åŠ©å’Œä¸ªæ€§åŒ–æ²»ç–—ç­‰æ–¹é¢" class="random-prompt">
                        <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
                    </div>
                    <div class="prompt-item">
                        <input type="text" value="èƒ½å¦æ·±å…¥æ¢è®¨é‡å­è®¡ç®—æŠ€æœ¯çš„åŸºæœ¬åŸç†ï¼Œä»¥åŠå®ƒç›¸æ¯”ç»å…¸è®¡ç®—æœºåœ¨å¯†ç å­¦å’Œè¯ç‰©ç ”å‘ä¸­çš„ä¼˜åŠ¿" class="random-prompt">
                        <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
                    </div>
                    <div class="prompt-item">
                        <input type="text" value="è¯·åˆ†æåŒºå—é“¾æŠ€æœ¯åœ¨ä¾›åº”é“¾ç®¡ç†ã€é‡‘èç§‘æŠ€å’Œæ•°å­—èº«ä»½è®¤è¯ä¸­çš„å®é™…åº”ç”¨æ¡ˆä¾‹å’Œå‘å±•è¶‹åŠ¿" class="random-prompt">
                        <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
                    </div>
                    <div class="prompt-item">
                        <input type="text" value="æ·±åº¦å­¦ä¹ åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸå–å¾—äº†å“ªäº›çªç ´æ€§è¿›å±•ï¼Œè¯·ç»“åˆGPTå’ŒBERTç­‰æ¨¡å‹è¿›è¡Œè¯´æ˜" class="random-prompt">
                        <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
                    </div>
                    <div class="prompt-item">
                        <input type="text" value="è¯·è§£é‡Š5Gå’Œ6Gç§»åŠ¨é€šä¿¡æŠ€æœ¯çš„æ ¸å¿ƒå·®å¼‚ï¼Œä»¥åŠå¯¹ç‰©è”ç½‘å’Œæ™ºæ…§åŸå¸‚å»ºè®¾çš„å½±å“" class="random-prompt">
                        <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
                    </div>
                    <div class="prompt-item">
                        <input type="text" value="æœºå™¨å­¦ä¹ æ¨¡å‹åœ¨å®é™…éƒ¨ç½²ä¸­é¢ä¸´å“ªäº›ä¼¦ç†å’Œéšç§ä¿æŠ¤é—®é¢˜ï¼Œåº”è¯¥å¦‚ä½•åˆ¶å®šç›¸åº”çš„ç›‘ç®¡æ”¿ç­–" class="random-prompt">
                        <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
                    </div>
                    <div class="prompt-item">
                        <input type="text" value="è¯·åˆ†æäº‘åŸç”ŸæŠ€æœ¯æ¶æ„çš„æ¼”è¿›å†ç¨‹ï¼ŒåŒ…æ‹¬å®¹å™¨åŒ–ã€å¾®æœåŠ¡å’ŒServerlessç­‰å…³é”®æŠ€æœ¯çš„ç‰¹ç‚¹" class="random-prompt">
                        <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
                    </div>
                    <div class="prompt-item">
                        <input type="text" value="èƒ½å¦ä»‹ç»è¾¹ç¼˜è®¡ç®—ä¸ä¼ ç»Ÿäº‘è®¡ç®—çš„åŒºåˆ«ï¼Œä»¥åŠåœ¨å·¥ä¸šäº’è”ç½‘å’Œè‡ªåŠ¨é©¾é©¶ä¸­çš„åº”ç”¨åœºæ™¯" class="random-prompt">
                        <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
                    </div>
                    <div class="prompt-item">
                        <input type="text" value="è¯·æ¢è®¨è®¡ç®—æœºè§†è§‰æŠ€æœ¯åœ¨å®‰é˜²ç›‘æ§ã€è‡ªåŠ¨é©¾é©¶å’ŒåŒ»ç–—å½±åƒåˆ†æä¸­çš„æœ€æ–°ç ”ç©¶æˆæœå’Œå®è·µç»éªŒ" class="random-prompt">
                        <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
                    </div>
                    <div class="prompt-item">
                        <input type="text" value="äººå·¥æ™ºèƒ½å¤§æ¨¡å‹çš„è®­ç»ƒéœ€è¦æ¶ˆè€—å¤§é‡è®¡ç®—èµ„æºï¼Œè¯·åˆ†æå…¶èƒ½æºæ¶ˆè€—é—®é¢˜å’Œå¯æŒç»­å‘å±•çš„è§£å†³æ–¹æ¡ˆ" class="random-prompt">
                        <button class="btn-small btn-add" onclick="addPromptField()">â• æ·»åŠ </button>
                    </div>
                </div>
            </div>

            <h3 style="margin: 25px 0 15px 0; font-size: 16px; font-weight: 600;">æµ‹å‹æ¨¡å¼</h3>
            <div class="mode-selector" id="rpmModeSelector">
                <div class="mode-option active" data-mode="fixed">
                    <div style="font-size: 18px; margin-bottom: 5px;">ğŸ“Š å›ºå®šæµ‹å‹</div>
                    <div style="font-size: 13px; color: #666;">è®¾å®šå›ºå®šRPMæŒç»­æµ‹è¯•</div>
                </div>
                <div class="mode-option" data-mode="auto">
                    <div style="font-size: 18px; margin-bottom: 5px;">ğŸ“ˆ è‡ªåŠ¨æµ‹å‹</div>
                    <div style="font-size: 13px; color: #666;">ä»èµ·å§‹RPMé€æ­¥é€’å¢è‡³æé™</div>
                </div>
            </div>

            <div id="fixedRPMGroup">
                <div class="form-group">
                    <label>ç›®æ ‡RPM *</label>
                    <input type="number" id="fixedRPM" value="60" min="1" max="1000">
                </div>
                <div class="form-group">
                    <label>æµ‹è¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="testDuration" value="0" min="0" max="1440" placeholder="0è¡¨ç¤ºä¸é™æ—¶ï¼Œä¸€ç›´æµ‹è¯•">
                    <small>0 = ä¸é™æ—¶ï¼ˆéœ€æ‰‹åŠ¨åœæ­¢ï¼‰ï¼Œæˆ–è®¾ç½®å…·ä½“åˆ†é’Ÿæ•°ï¼ˆå¦‚ï¼š10åˆ†é’Ÿåè‡ªåŠ¨åœæ­¢ï¼‰</small>
                </div>
            </div>

            <div class="form-group" id="autoRPMGroup" style="display: none;">
                <label>èµ·å§‹RPM</label>
                <input type="number" id="autoRPM" value="10" min="1" max="1000">
                <small>ç³»ç»Ÿå°†æ¯åˆ†é’Ÿè‡ªåŠ¨å¢åŠ 10 RPMï¼Œç›´åˆ°è¾¾åˆ°æ‰¿å—æé™è‡ªåŠ¨åœæ­¢</small>
            </div>

            <div class="control-buttons">
                <button class="btn btn-primary" id="startBtn" onclick="startTest()">
                    ğŸš€ å¼€å§‹æµ‹å‹
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopTest()" disabled>
                    â¹ åœæ­¢æµ‹è¯•
                </button>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ•°æ® -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value primary" id="totalRequests">0</div>
                <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value success" id="successRate">100%</div>
                <div class="stat-label">æ€»ä½“æˆåŠŸç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value danger" id="failureRate">0%</div>
                <div class="stat-label">æ€»ä½“å¤±è´¥ç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value warning" id="avgResponseTime">0ms</div>
                <div class="stat-label">å¹³å‡å“åº”æ—¶é—´</div>
            </div>
        </div>

        <!-- æœ¬åˆ†é’Ÿç»Ÿè®¡æ•°æ® -->
        <div class="config-section" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);">
            <h2 class="section-title">ğŸ“Š æœ¬åˆ†é’Ÿç»Ÿè®¡ (å®æ—¶)</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value primary" id="minuteTotalRequests">0</div>
                    <div class="stat-label">æœ¬åˆ†é’Ÿè¯·æ±‚æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value success" id="minuteSuccessRate">100%</div>
                    <div class="stat-label">æœ¬åˆ†é’ŸæˆåŠŸç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value danger" id="minuteFailureRate">0%</div>
                    <div class="stat-label">æœ¬åˆ†é’Ÿå¤±è´¥ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTimer" style="color: #667eea;">00:00:00</div>
                    <div class="stat-label">æ€»å…±è¿è¡Œæ—¶é—´</div>
                </div>
            </div>
        </div>

        <!-- æˆåŠŸ/å¤±è´¥æ›²çº¿å›¾ -->
        <div class="chart-container">
            <h2 class="section-title">ğŸ“ˆ æ¯åˆ†é’ŸæˆåŠŸ/å¤±è´¥è¶‹åŠ¿å›¾</h2>
            <div class="chart-wrapper">
                <canvas id="statsChart"></canvas>
            </div>
            <div id="chartPlaceholder" class="empty-state">å¼€å§‹æµ‹è¯•åå°†æ˜¾ç¤ºè¶‹åŠ¿å›¾</div>
        </div>

        <!-- è¯·æ±‚æ—¥å¿— -->
        <div class="request-logs">
            <div class="section-header">
                <h2 class="section-title" style="margin: 0;">ğŸ“‹ è¯·æ±‚æ—¥å¿—</h2>
                <button class="clear-logs-btn" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
            </div>
            <div id="requestLogsContainer">
                <div class="empty-state">æš‚æ— è¯·æ±‚æ—¥å¿—</div>
            </div>
        </div>

        <!-- é”™è¯¯ç»Ÿè®¡ -->
        <div class="error-summary">
            <h2 class="section-title">é”™è¯¯ç»Ÿè®¡</h2>
            <div id="errorSummary" class="empty-state">æš‚æ— é”™è¯¯</div>
        </div>

        <!-- é”™è¯¯æ—¥å¿— -->
        <div class="error-logs">
            <h2 class="section-title">æœ€è¿‘é”™è¯¯æ—¥å¿—</h2>
            <div id="errorLogs" class="empty-state">æš‚æ— é”™è¯¯æ—¥å¿—</div>
        </div>
    </div>

    <script>
        let ws;
        let authToken = localStorage.getItem('authToken');
        let currentRPMMode = 'fixed';
        let currentPromptMode = 'fixed';
        let currentRequestType = 'stream';
        let statsChart;

        // éªŒè¯ç™»å½•
        if (!authToken) {
            window.location.href = '/';
        }

        // æ€»è¿è¡Œæ—¶é—´è®¡æ—¶å™¨
        let totalTimerInterval = null;
        let testStartTime = null;

        function startTotalTimer(startTime) {
            testStartTime = startTime;
            if (totalTimerInterval) {
                clearInterval(totalTimerInterval);
            }
            totalTimerInterval = setInterval(() => {
                if (!testStartTime) return;
                const elapsed = Date.now() - testStartTime;
                const seconds = Math.floor(elapsed / 1000) % 60;
                const minutes = Math.floor(elapsed / 60000) % 60;
                const hours = Math.floor(elapsed / 3600000);
                document.getElementById('totalTimer').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function stopTotalTimer() {
            if (totalTimerInterval) {
                clearInterval(totalTimerInterval);
                totalTimerInterval = null;
            }
            testStartTime = null;
            document.getElementById('totalTimer').textContent = '00:00:00';
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            connectWebSocket();
            initModeSelectors();
            initChart();
            initCharCounter();
            updateProviderHints(); // â­ v2.0æ–°å¢ï¼šåˆå§‹åŒ–AIæä¾›å•†æç¤º
            loadSavedConfig(); // åŠ è½½ä¿å­˜çš„é…ç½®
        });

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            try {
                const canvas = document.getElementById('statsChart');
                if (!canvas) {
                    console.error('Canvas element not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                statsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'æˆåŠŸæ¬¡æ•°',
                                data: [],
                                borderColor: '#27ae60',
                                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                                tension: 0.3,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 5,
                                borderWidth: 2
                            },
                            {
                                label: 'å¤±è´¥æ¬¡æ•°',
                                data: [],
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.3,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 5,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 20,
                                    padding: 15,
                                    font: {
                                        size: 13
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    title: function(context) {
                                        return 'æ—¶é—´: ' + context[0].label;
                                    },
                                    afterBody: function(context) {
                                        const index = context[0].dataIndex;
                                        const success = context[0].dataset.data[index];
                                        const failure = context[1].dataset.data[index];
                                        const total = success + failure;
                                        const rate = total > 0 ? ((success / total) * 100).toFixed(2) : '100.00';
                                        return '\næˆåŠŸç‡: ' + rate + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: true,
                                    autoSkipPadding: 20,
                                    maxTicksLimit: 20,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    precision: 0,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        elements: {
                            line: {
                                borderJoinStyle: 'round'
                            }
                        }
                    }
                });
                
                console.log('Chart initialized successfully');
            } catch (error) {
                console.error('Error initializing chart:', error);
            }
        }

        // æ›´æ–°å›¾è¡¨
        function updateChart(minuteStats) {
            if (!statsChart) {
                console.warn('Chart not initialized');
                return;
            }
            
            if (!minuteStats || minuteStats.length === 0) {
                document.getElementById('chartPlaceholder').style.display = 'block';
                document.getElementById('statsChart').style.display = 'none';
                return;
            }

            document.getElementById('chartPlaceholder').style.display = 'none';
            document.getElementById('statsChart').style.display = 'block';

            const labels = minuteStats.map(stat => {
                const date = new Date(stat.timestamp);
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            });

            const successData = minuteStats.map(stat => stat.successCount);
            const failureData = minuteStats.map(stat => stat.failureCount);

            statsChart.data.labels = labels;
            statsChart.data.datasets[0].data = successData;
            statsChart.data.datasets[1].data = failureData;
            
            try {
                statsChart.update('none'); // 'none' for better performance
            } catch (error) {
                console.error('Error updating chart:', error);
            }
        }

        // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°å™¨
        function initCharCounter() {
            const textarea = document.getElementById('testPrompt');
            const counter = document.getElementById('charCount');
            
            textarea.addEventListener('input', () => {
                const length = textarea.value.length;
                counter.textContent = length.toLocaleString();
                
                if (length > 200000) {
                    counter.style.color = '#e74c3c';
                    textarea.value = textarea.value.substring(0, 200000);
                } else if (length > 180000) {
                    counter.style.color = '#f39c12';
                } else {
                    counter.style.color = '#27ae60';
                }
            });
        }

        // WebSocketè¿æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                console.log('WebSocketå·²è¿æ¥');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onclose = () => {
                console.log('WebSocketè¿æ¥æ–­å¼€ï¼Œ5ç§’åé‡è¿...');
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
            };
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'stateUpdate':
                case 'statsUpdate':
                    updateUI(message.data);
                    break;
                case 'testStopped':
                    handleTestStopped(message.data);
                    break;
                case 'rpmIncreased':
                    showNotification(`RPMå·²å¢åŠ è‡³ ${message.data.newRPM}`);
                    break;
                case 'minuteStatsUpdate':
                    updateChart(message.data);
                    break;
                case 'requestLogUpdate':
                    addRequestLogToUI(message.data);
                    break;
                case 'logsCleared':
                    updateRequestLogs([]);
                    break;
                case 'currentMinuteStatsUpdate':
                    updateCurrentMinuteStats(message.data);
                    break;
            }
        }

        // æ›´æ–°å½“å‰åˆ†é’Ÿç»Ÿè®¡
        function updateCurrentMinuteStats(minuteStats) {
            document.getElementById('minuteTotalRequests').textContent = minuteStats.totalRequests || 0;
            document.getElementById('minuteSuccessRate').textContent = (minuteStats.successRate || 100) + '%';
            document.getElementById('minuteFailureRate').textContent = (minuteStats.failureRate || 0) + '%';
        }

        // æ›´æ–°UI
        function updateUI(state) {
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (state.isRunning) {
                indicator.className = 'status-indicator status-running';
                const promptMode = state.config.promptMode === 'random' ? 'éšæœºè¯­å¥' : 'å›ºå®šè¯­å¥';
                const rpmMode = state.mode === 'auto' ? 'è‡ªåŠ¨æ¨¡å¼' : 'å›ºå®šæ¨¡å¼';
                statusText.textContent = `æµ‹è¯•è¿›è¡Œä¸­ (${rpmMode} / ${promptMode})`;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                // å¯åŠ¨æ€»è¿è¡Œæ—¶é—´è®¡æ—¶å™¨ï¼Œä½¿ç”¨æœåŠ¡å™¨çš„startTime
                if (!totalTimerInterval && state.startTime) {
                    startTotalTimer(state.startTime);
                }
            } else {
                indicator.className = 'status-indicator status-stopped';
                statusText.textContent = 'å‡†å¤‡å°±ç»ª';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                stopTotalTimer();
            }

            // æ›´æ–°å½“å‰RPM
            document.getElementById('currentRPM').textContent = `å½“å‰ RPM: ${state.currentRPM || 0}`;

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const stats = state.stats || {};
            document.getElementById('totalRequests').textContent = (stats.totalRequests || 0).toLocaleString();
            document.getElementById('successRate').textContent = (stats.successRate || 100) + '%';
            document.getElementById('failureRate').textContent = (stats.failureRate || 0) + '%';
            document.getElementById('avgResponseTime').textContent = (stats.avgResponseTime || 0).toLocaleString() + 'ms';

            // æ›´æ–°å›¾è¡¨
            if (stats.minuteStats && stats.minuteStats.length > 0) {
                updateChart(stats.minuteStats);
            }

            // æ›´æ–°é”™è¯¯ç»Ÿè®¡
            updateErrorSummary(stats.errors || {});

            // æ›´æ–°é”™è¯¯æ—¥å¿—
            updateErrorLogs(stats.errorLogs || []);
            
            // æ›´æ–°è¯·æ±‚æ—¥å¿—
            updateRequestLogs(stats.requestLogs || []);
        }

        // æ›´æ–°é”™è¯¯ç»Ÿè®¡
        function updateErrorSummary(errors) {
            const container = document.getElementById('errorSummary');
            
            if (Object.keys(errors).length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— é”™è¯¯</div>';
                return;
            }

            const sortedErrors = Object.entries(errors)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            container.innerHTML = sortedErrors.map(([message, count]) => `
                <div class="error-item">
                    <div class="error-message">${escapeHtml(message)}</div>
                    <div class="error-count">${count}</div>
                </div>
            `).join('');
        }

        // æ›´æ–°é”™è¯¯æ—¥å¿—
        function updateErrorLogs(logs) {
            const container = document.getElementById('errorLogs');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— é”™è¯¯æ—¥å¿—</div>';
                return;
            }

            container.innerHTML = logs.slice(0, 20).map(log => `
                <div class="log-item">
                    <span class="log-time">${new Date(log.time).toLocaleString()}</span>
                    ${log.statusCode ? `<strong>[${log.statusCode}]</strong> ` : ''}
                    ${escapeHtml(log.message)}
                </div>
            `).join('');
        }

        // æ¨¡å¼é€‰æ‹©å™¨
        function initModeSelectors() {
            // è¯·æ±‚ç±»å‹é€‰æ‹©å™¨
            const requestTypeOptions = document.querySelectorAll('#requestTypeSelector .mode-option');
            requestTypeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    requestTypeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    currentRequestType = option.dataset.type;
                });
            });

            // RPMæ¨¡å¼é€‰æ‹©å™¨
            const rpmOptions = document.querySelectorAll('#rpmModeSelector .mode-option');
            rpmOptions.forEach(option => {
                option.addEventListener('click', () => {
                    rpmOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    currentRPMMode = option.dataset.mode;
                    
                    if (currentRPMMode === 'fixed') {
                        document.getElementById('fixedRPMGroup').style.display = 'block';
                        document.getElementById('autoRPMGroup').style.display = 'none';
                    } else {
                        document.getElementById('fixedRPMGroup').style.display = 'none';
                        document.getElementById('autoRPMGroup').style.display = 'block';
                    }
                });
            });

            // è¯­å¥æ¨¡å¼é€‰æ‹©å™¨
            const promptOptions = document.querySelectorAll('#promptModeSelector .mode-option');
            promptOptions.forEach(option => {
                option.addEventListener('click', () => {
                    promptOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    currentPromptMode = option.dataset.mode;
                    
                    if (currentPromptMode === 'fixed') {
                        document.getElementById('fixedPromptGroup').style.display = 'block';
                        document.getElementById('randomPromptGroup').style.display = 'none';
                    } else {
                        document.getElementById('fixedPromptGroup').style.display = 'none';
                        document.getElementById('randomPromptGroup').style.display = 'block';
                    }
                });
            });
        }

        // æ·»åŠ éšæœºè¯­å¥è¾“å…¥æ¡†
        function addPromptField() {
            const list = document.getElementById('promptList');
            const newItem = document.createElement('div');
            newItem.className = 'prompt-item';
            newItem.innerHTML = `
                <input type="text" placeholder="è¾“å…¥æµ‹è¯•è¯­å¥..." class="random-prompt">
                <button class="btn-small btn-remove" onclick="removePromptField(this)">âŒ åˆ é™¤</button>
            `;
            list.appendChild(newItem);
        }

        // åˆ é™¤éšæœºè¯­å¥è¾“å…¥æ¡†
        function removePromptField(btn) {
            btn.parentElement.remove();
        }

        // è·å–éšæœºè¯­å¥åˆ—è¡¨
        function getRandomPrompts() {
            const inputs = document.querySelectorAll('.random-prompt');
            const prompts = [];
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    prompts.push(value);
                }
            });
            return prompts;
        }

        // ä¿å­˜é…ç½®åˆ°localStorage
        function saveConfig() {
            const config = {
                providerType: document.getElementById('providerType').value, // â­ v2.0æ–°å¢
                url: document.getElementById('url').value.trim(),
                modelName: document.getElementById('modelName').value.trim(),
                apiKey: document.getElementById('apiKey').value.trim(),
                testPrompt: document.getElementById('testPrompt').value.trim(),
                fixedRPM: document.getElementById('fixedRPM').value,
                autoRPM: document.getElementById('autoRPM').value,
                testDuration: document.getElementById('testDuration').value,
                rpmMode: currentRPMMode,
                promptMode: currentPromptMode,
                requestType: currentRequestType,
                randomPrompts: getRandomPrompts()
            };
            localStorage.setItem('autoCeyaConfig', JSON.stringify(config));
            console.log('é…ç½®å·²ä¿å­˜');
        }

        // åŠ è½½ä¿å­˜çš„é…ç½®
        function loadSavedConfig() {
            try {
                const savedConfig = localStorage.getItem('autoCeyaConfig');
                if (!savedConfig) {
                    console.log('æ²¡æœ‰ä¿å­˜çš„é…ç½®');
                    return;
                }

                const config = JSON.parse(savedConfig);
                console.log('åŠ è½½ä¿å­˜çš„é…ç½®:', config);

                // â­ v2.0æ–°å¢ï¼šæ¢å¤AIæä¾›å•†é€‰æ‹©
                if (config.providerType) {
                    document.getElementById('providerType').value = config.providerType;
                    updateProviderHints(); // æ›´æ–°æç¤ºä¿¡æ¯
                }

                // æ¢å¤åŸºæœ¬é…ç½®
                if (config.url) document.getElementById('url').value = config.url;
                if (config.modelName) document.getElementById('modelName').value = config.modelName;
                if (config.apiKey) document.getElementById('apiKey').value = config.apiKey;
                if (config.testPrompt) document.getElementById('testPrompt').value = config.testPrompt;
                if (config.fixedRPM) document.getElementById('fixedRPM').value = config.fixedRPM;
                if (config.autoRPM) document.getElementById('autoRPM').value = config.autoRPM;
                if (config.testDuration) document.getElementById('testDuration').value = config.testDuration;

                // æ¢å¤è¯·æ±‚ç±»å‹
                if (config.requestType) {
                    currentRequestType = config.requestType;
                    document.querySelectorAll('#requestTypeSelector .mode-option').forEach(opt => {
                        opt.classList.remove('active');
                        if (opt.dataset.type === config.requestType) {
                            opt.classList.add('active');
                        }
                    });
                }

                // æ¢å¤RPMæ¨¡å¼
                if (config.rpmMode) {
                    currentRPMMode = config.rpmMode;
                    document.querySelectorAll('#rpmModeSelector .mode-option').forEach(opt => {
                        opt.classList.remove('active');
                        if (opt.dataset.mode === config.rpmMode) {
                            opt.classList.add('active');
                        }
                    });
                    
                    if (config.rpmMode === 'fixed') {
                        document.getElementById('fixedRPMGroup').style.display = 'block';
                        document.getElementById('autoRPMGroup').style.display = 'none';
                    } else {
                        document.getElementById('fixedRPMGroup').style.display = 'none';
                        document.getElementById('autoRPMGroup').style.display = 'block';
                    }
                }

                // æ¢å¤è¯­å¥æ¨¡å¼
                if (config.promptMode) {
                    currentPromptMode = config.promptMode;
                    document.querySelectorAll('#promptModeSelector .mode-option').forEach(opt => {
                        opt.classList.remove('active');
                        if (opt.dataset.mode === config.promptMode) {
                            opt.classList.add('active');
                        }
                    });
                    
                    if (config.promptMode === 'fixed') {
                        document.getElementById('fixedPromptGroup').style.display = 'block';
                        document.getElementById('randomPromptGroup').style.display = 'none';
                    } else {
                        document.getElementById('fixedPromptGroup').style.display = 'none';
                        document.getElementById('randomPromptGroup').style.display = 'block';
                    }
                }

                // æ¢å¤éšæœºè¯­å¥åˆ—è¡¨
                if (config.randomPrompts && config.randomPrompts.length > 0) {
                    const list = document.getElementById('promptList');
                    list.innerHTML = '';
                    config.randomPrompts.forEach((prompt, index) => {
                        const item = document.createElement('div');
                        item.className = 'prompt-item';
                        item.innerHTML = `
                            <input type="text" value="${escapeHtml(prompt)}" class="random-prompt">
                            <button class="btn-small ${index === config.randomPrompts.length - 1 ? 'btn-add' : 'btn-remove'}" 
                                    onclick="${index === config.randomPrompts.length - 1 ? 'addPromptField()' : 'removePromptField(this)'}">
                                ${index === config.randomPrompts.length - 1 ? 'â• æ·»åŠ ' : 'âŒ åˆ é™¤'}
                            </button>
                        `;
                        list.appendChild(item);
                    });
                }

                // æ›´æ–°å­—ç¬¦è®¡æ•°
                const charCount = document.getElementById('testPrompt').value.length;
                document.getElementById('charCount').textContent = charCount.toLocaleString();

                showNotification('å·²è‡ªåŠ¨åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„é…ç½®', 'success');
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // å¼€å§‹æµ‹è¯•
        // â­ v2.0æ–°å¢ï¼šæ ¹æ®AIæä¾›å•†æ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯
        function updateProviderHints() {
            const providerType = document.getElementById('providerType').value;
            const urlInput = document.getElementById('url');
            const modelInput = document.getElementById('modelName');
            const urlHint = document.getElementById('urlHint');
            const modelHint = document.getElementById('modelHint');
            const apiKeyHint = document.getElementById('apiKeyHint');
            
            if (providerType === 'gemini') {
                urlInput.placeholder = 'https://generativelanguage.googleapis.com';
                modelInput.placeholder = 'gemini-1.5-flash';
                urlHint.textContent = 'ç¤ºä¾‹ï¼šhttps://generativelanguage.googleapis.com';
                modelHint.textContent = 'ç¤ºä¾‹ï¼šgemini-1.5-flash, gemini-1.5-pro, gemini-pro';
                apiKeyHint.textContent = 'ä» Google AI Studio è·å–';
            } else if (providerType === 'openai') {
                urlInput.placeholder = 'https://api.openai.com';
                modelInput.placeholder = 'gpt-4';
                urlHint.textContent = 'ç¤ºä¾‹ï¼šhttps://api.openai.com æˆ–ç¬¬ä¸‰æ–¹ä»£ç†åœ°å€';
                modelHint.textContent = 'ç¤ºä¾‹ï¼šgpt-4, gpt-3.5-turbo, gpt-4-turbo';
                apiKeyHint.textContent = 'ä»¥ sk- å¼€å¤´çš„å¯†é’¥';
            } else if (providerType === 'claude') {
                urlInput.placeholder = 'https://api.anthropic.com';
                modelInput.placeholder = 'claude-3-opus-20240229';
                urlHint.textContent = 'ç¤ºä¾‹ï¼šhttps://api.anthropic.com';
                modelHint.textContent = 'ç¤ºä¾‹ï¼šclaude-3-opus-20240229, claude-3-sonnet-20240229';
                apiKeyHint.textContent = 'ä»¥ sk-ant- å¼€å¤´çš„å¯†é’¥';
            }
        }

        async function startTest() {
            const providerType = document.getElementById('providerType').value; // â­ v2.0æ–°å¢
            const url = document.getElementById('url').value.trim();
            const modelName = document.getElementById('modelName').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const rpm = currentRPMMode === 'fixed' 
                ? parseInt(document.getElementById('fixedRPM').value)
                : parseInt(document.getElementById('autoRPM').value);
            const testDuration = currentRPMMode === 'fixed' 
                ? parseInt(document.getElementById('testDuration').value) || 0
                : 0;

            if (!url || !modelName || !apiKey) {
                alert('è¯·å¡«å†™URLã€æ¨¡å‹åç§°å’ŒAPIå¯†é’¥ï¼');
                return;
            }

            let testPrompt = '';
            let randomPrompts = [];

            if (currentPromptMode === 'fixed') {
                testPrompt = document.getElementById('testPrompt').value.trim();
                if (!testPrompt) {
                    alert('è¯·å¡«å†™æµ‹è¯•è¯­å¥ï¼');
                    return;
                }
            } else {
                randomPrompts = getRandomPrompts();
                if (randomPrompts.length === 0) {
                    alert('è¯·è‡³å°‘æ·»åŠ ä¸€æ¡æµ‹è¯•è¯­å¥ï¼');
                    return;
                }
            }

            // ä¿å­˜é…ç½®
            saveConfig();

            try {
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        providerType, // â­ v2.0æ–°å¢ï¼šAIæä¾›å•†ç±»å‹
                        mode: currentRPMMode,
                        rpm,
                        url,
                        modelName,
                        apiKey,
                        testPrompt,
                        promptMode: currentPromptMode,
                        randomPrompts,
                        requestType: currentRequestType,
                        testDuration
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const durationMsg = testDuration > 0 ? `ï¼Œå°†è¿è¡Œ${testDuration}åˆ†é’Ÿåè‡ªåŠ¨åœæ­¢` : '';
                    showNotification('æµ‹è¯•å·²å¯åŠ¨' + durationMsg + 'ï¼', 'success');
                } else {
                    alert('å¯åŠ¨å¤±è´¥ï¼š' + data.error);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }

        // åœæ­¢æµ‹è¯•
        async function stopTest() {
            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('æµ‹è¯•å·²åœæ­¢', 'warning');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }

        // æµ‹è¯•åœæ­¢å¤„ç†
        function handleTestStopped(data) {
            const message = `æµ‹è¯•å·²åœæ­¢\nåŸå› : ${data.reason}\næ€»è¯·æ±‚: ${data.finalStats.totalRequests}\næˆåŠŸç‡: ${data.finalStats.successRate}%${data.maxRPM ? `\næœ€å¤§RPM: ${data.maxRPM}` : ''}`;
            alert(message);
        }

        // é€šçŸ¥æç¤º
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æŸ¥çœ‹å†å²è®°å½•
        function viewHistory() {
            window.location.href = '/history';
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/';
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ›´æ–°è¯·æ±‚æ—¥å¿—æ˜¾ç¤º
        function updateRequestLogs(logs) {
            const container = document.getElementById('requestLogsContainer');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— è¯·æ±‚æ—¥å¿—</div>';
                return;
            }

            const tableHTML = `
                <table class="request-log-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>è¯·æ±‚ç±»å‹</th>
                            <th>çŠ¶æ€ç </th>
                            <th>è€—æ—¶(ms)</th>
                            <th>æ¨¡å‹</th>
                            <th>è¯¦æƒ…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.slice(0, 100).map(log => {
                            const time = new Date(log.time).toLocaleTimeString('zh-CN');
                            const statusBadge = log.status === 'success' 
                                ? '<span class="status-badge success">æˆåŠŸ</span>'
                                : '<span class="status-badge failure">å¤±è´¥</span>';
                            
                            return `
                                <tr>
                                    <td>${time}</td>
                                    <td>${statusBadge}</td>
                                    <td>${log.requestType || 'æµå¼'}</td>
                                    <td>${log.statusCode || '-'}</td>
                                    <td>${log.responseTime}</td>
                                    <td>${escapeHtml(log.modelName)}</td>
                                    <td>
                                        ${log.error ? `<div class="error-detail">${escapeHtml(log.error)}</div>` : '-'}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        // æ·»åŠ å•æ¡æ—¥å¿—åˆ°UI
        function addRequestLogToUI(log) {
            const container = document.getElementById('requestLogsContainer');
            
            // å¦‚æœæ˜¯ç©ºçŠ¶æ€ï¼Œå…ˆåˆ›å»ºè¡¨æ ¼
            if (container.innerHTML.includes('empty-state')) {
                updateRequestLogs([log]);
                return;
            }

            // è·å–tbody
            const tbody = container.querySelector('tbody');
            if (!tbody) {
                updateRequestLogs([log]);
                return;
            }

            const time = new Date(log.time).toLocaleTimeString('zh-CN');
            const statusBadge = log.status === 'success' 
                ? '<span class="status-badge success">æˆåŠŸ</span>'
                : '<span class="status-badge failure">å¤±è´¥</span>';
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${time}</td>
                <td>${statusBadge}</td>
                <td>${log.requestType || 'æµå¼'}</td>
                <td>${log.statusCode || '-'}</td>
                <td>${log.responseTime}</td>
                <td>${escapeHtml(log.modelName)}</td>
                <td>
                    ${log.error ? `<div class="error-detail">${escapeHtml(log.error)}</div>` : '-'}
                </td>
            `;
            
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // é™åˆ¶æ˜¾ç¤º100æ¡
            const rows = tbody.querySelectorAll('tr');
            if (rows.length > 100) {
                tbody.removeChild(tbody.lastChild);
            }
        }

        // æ¸…é™¤æ—¥å¿—
        async function clearLogs() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è¯·æ±‚æ—¥å¿—å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch('/api/clearLogs', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    updateRequestLogs([]);
                    showNotification('æ—¥å¿—å·²æ¸…é™¤', 'success');
                }
            } catch (error) {
                alert('æ¸…é™¤æ—¥å¿—å¤±è´¥ï¼š' + error.message);
            }
        }
    </script>
</body>
</html>
