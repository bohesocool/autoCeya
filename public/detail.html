<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCeya - æµ‹è¯•è¯¦æƒ…</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .info-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .info-value.highlight {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #999;
            font-size: 14px;
        }

        .success { color: #27ae60; }
        .danger { color: #e74c3c; }
        .warning { color: #f39c12; }
        .primary { color: #667eea; }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .error-summary {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .error-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-message {
            flex: 1;
            margin-right: 15px;
            word-break: break-word;
        }

        .error-count {
            background: #e74c3c;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #667eea;
            font-size: 18px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading::before {
            content: "â³";
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .mode-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }

        .mode-auto {
            background: #e3f2fd;
            color: #1976d2;
        }

        .mode-fixed {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ“‹ æµ‹è¯•è¯¦æƒ…</h1>
            <button class="btn-secondary" onclick="goBack()">è¿”å›åˆ—è¡¨</button>
        </div>
    </div>

    <div class="container" id="content">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let statsChart;

        // éªŒè¯ç™»å½•
        if (!authToken) {
            window.location.href = '/';
        }

        // è·å–URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const historyId = urlParams.get('id');

        if (!historyId) {
            document.getElementById('content').innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 20px;">âŒ</div>
                    <div>æ— æ•ˆçš„è®°å½•ID</div>
                </div>
            `;
        } else {
            loadDetail();
        }

        // åŠ è½½è¯¦æƒ…
        async function loadDetail() {
            try {
                const response = await fetch(`/api/history/${historyId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const data = await response.json();
                renderDetail(data);
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 20px;">âŒ</div>
                        <div>åŠ è½½å¤±è´¥: ${error.message}</div>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“è¯¦æƒ…
        function renderDetail(data) {
            const startTime = new Date(data.start_time);
            const endTime = new Date(data.end_time);
            const duration = formatDuration(data.duration);
            const modeClass = data.test_mode === 'auto' ? 'mode-auto' : 'mode-fixed';
            const modeText = data.test_mode === 'auto' ? 'è‡ªåŠ¨æµ‹å‹' : 'å›ºå®šæµ‹å‹';
            const promptModeText = data.prompt_mode === 'random' ? 'éšæœºè¯­å¥' : 'å›ºå®šè¯­å¥';
            const requestTypeText = data.request_type === 'stream' ? 'æµå¼è¯·æ±‚' : 'éæµå¼è¯·æ±‚';
            const minuteStats = typeof data.minuteStats === 'string' ? JSON.parse(data.minuteStats) : data.minuteStats;
            const errorSummary = typeof data.errorSummary === 'string' ? JSON.parse(data.errorSummary) : data.errorSummary;

            const html = `
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="info-card">
                    <h2 class="section-title">åŸºæœ¬ä¿¡æ¯ <span class="mode-badge ${modeClass}">${modeText}</span></h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">æµ‹è¯•ç«™ç‚¹</span>
                            <span class="info-value">${escapeHtml(data.test_url)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ¨¡å‹åç§°</span>
                            <span class="info-value">${escapeHtml(data.model_name)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æµ‹è¯•æ¨¡å¼</span>
                            <span class="info-value">${modeText}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è¯­å¥æ¨¡å¼</span>
                            <span class="info-value">${promptModeText}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è¯·æ±‚ç±»å‹</span>
                            <span class="info-value">${requestTypeText}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å¼€å§‹æ—¶é—´</span>
                            <span class="info-value">${formatDateTime(startTime)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ç»“æŸæ—¶é—´</span>
                            <span class="info-value">${formatDateTime(endTime)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æµ‹è¯•æ—¶é•¿</span>
                            <span class="info-value highlight">${duration}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">${data.test_mode === 'auto' ? 'æœ€å¤§RPM' : 'ç›®æ ‡RPM'}</span>
                            <span class="info-value highlight">${data.max_rpm || data.target_rpm}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">åœæ­¢åŸå› </span>
                            <span class="info-value">${escapeHtml(data.stop_reason || 'æ‰‹åŠ¨åœæ­¢')}</span>
                        </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ•°æ® -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value primary">${data.total_requests.toLocaleString()}</div>
                        <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value success">${data.success_rate}%</div>
                        <div class="stat-label">æˆåŠŸç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value success">${data.success_count.toLocaleString()}</div>
                        <div class="stat-label">æˆåŠŸæ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value danger">${data.failure_count.toLocaleString()}</div>
                        <div class="stat-label">å¤±è´¥æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value warning">${data.avg_response_time.toLocaleString()}ms</div>
                        <div class="stat-label">å¹³å‡å“åº”æ—¶é—´</div>
                    </div>
                </div>

                <!-- æˆåŠŸ/å¤±è´¥è¶‹åŠ¿å›¾ -->
                <div class="chart-container">
                    <h2 class="section-title">ğŸ“ˆ æ¯åˆ†é’ŸæˆåŠŸ/å¤±è´¥è¶‹åŠ¿å›¾</h2>
                    <div class="chart-wrapper">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>

                <!-- é”™è¯¯ç»Ÿè®¡ -->
                <div class="error-summary">
                    <h2 class="section-title">é”™è¯¯ç»Ÿè®¡</h2>
                    <div id="errorSummary"></div>
                </div>
            `;

            document.getElementById('content').innerHTML = html;

            // æ¸²æŸ“å›¾è¡¨
            if (minuteStats && minuteStats.length > 0) {
                renderChart(minuteStats);
            }

            // æ¸²æŸ“é”™è¯¯ç»Ÿè®¡
            if (errorSummary && Object.keys(errorSummary).length > 0) {
                renderErrorSummary(errorSummary);
            } else {
                document.getElementById('errorSummary').innerHTML = '<div class="empty-state">æ— é”™è¯¯è®°å½•</div>';
            }
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(minuteStats) {
            try {
                const canvas = document.getElementById('statsChart');
                const ctx = canvas.getContext('2d');

                const labels = minuteStats.map(stat => {
                    const date = new Date(stat.timestamp);
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                });

                const successData = minuteStats.map(stat => stat.successCount);
                const failureData = minuteStats.map(stat => stat.failureCount);

                statsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'æˆåŠŸæ¬¡æ•°',
                                data: successData,
                                borderColor: '#27ae60',
                                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                                tension: 0.3,
                                fill: true,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                borderWidth: 2
                            },
                            {
                                label: 'å¤±è´¥æ¬¡æ•°',
                                data: failureData,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.3,
                                fill: true,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 20,
                                    padding: 15,
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    title: function(context) {
                                        return 'æ—¶é—´: ' + context[0].label;
                                    },
                                    afterBody: function(context) {
                                        const index = context[0].dataIndex;
                                        const success = context[0].dataset.data[index];
                                        const failure = context[1].dataset.data[index];
                                        const total = success + failure;
                                        const rate = total > 0 ? ((success / total) * 100).toFixed(2) : '100.00';
                                        return '\næˆåŠŸç‡: ' + rate + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: true,
                                    autoSkipPadding: 20,
                                    maxTicksLimit: 20,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    precision: 0,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering chart:', error);
            }
        }

        // æ¸²æŸ“é”™è¯¯ç»Ÿè®¡
        function renderErrorSummary(errors) {
            const sortedErrors = Object.entries(errors)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const html = sortedErrors.map(([message, count]) => `
                <div class="error-item">
                    <div class="error-message">${escapeHtml(message)}</div>
                    <div class="error-count">${count}</div>
                </div>
            `).join('');

            document.getElementById('errorSummary').innerHTML = html;
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            const h = hours > 0 ? `${hours}å°æ—¶` : '';
            const m = minutes % 60 > 0 ? `${minutes % 60}åˆ†` : '';
            const s = seconds % 60 > 0 ? `${seconds % 60}ç§’` : '';
            
            return (h + m + s) || '0ç§’';
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(date) {
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // è¿”å›åˆ—è¡¨
        function goBack() {
            window.location.href = '/history';
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    <!-- ç‰ˆæœ¬å· -->
    <footer style="text-align: center; padding: 20px; color: #999; font-size: 12px; margin-top: 30px;">
        AutoCeya v2.0.4 | AI å‹åŠ›æµ‹è¯•å·¥å…·
    </footer>
</body>
</html>

