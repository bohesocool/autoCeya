# 实施计划 - 修复 AI 服务流式和非流式请求

## 任务列表

- [x] 1. 创建 SSE 解析工具类


  - 实现 SSE 流解析逻辑
  - 实现内容提取方法
  - 处理不同提供商的响应格式
  - _验证需求: 1.2, 1.3, 2.2, 2.3, 3.2, 3.3_

- [x] 1.1 为 SSE 解析器编写单元测试






  - 测试完整 SSE 流解析
  - 测试不完整数据行处理
  - 测试 [DONE] 标记处理
  - 测试错误处理
  - _验证需求: 所有需求_

- [x] 2. 重构 OpenAI 服务


  - 拆分流式和非流式请求方法
  - 实现非流式请求的内容提取
  - 实现流式请求的 SSE 解析
  - 添加首字节时间（TTFB）记录
  - _验证需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2.1 为 OpenAI 服务编写单元测试






  - 测试非流式请求
  - 测试流式请求
  - 测试错误处理
  - 测试超时处理
  - _验证需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2.2 为 OpenAI 服务编写属性测试






  - **属性 1: 流式响应完整性**
  - **验证需求: 1.3**

- [x] 3. 重构 Claude 服务

  - 拆分流式和非流式请求方法
  - 实现非流式请求的内容提取（从 content 数组）
  - 实现流式请求的 SSE 解析（处理 delta.text）
  - 添加首字节时间（TTFB）记录
  - _验证需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 3.1 为 Claude 服务编写单元测试






  - 测试非流式请求
  - 测试流式请求
  - 测试错误处理
  - 测试超时处理
  - _验证需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 3.2 为 Claude 服务编写属性测试






  - **属性 1: 流式响应完整性**
  - **验证需求: 2.3**

- [x] 4. 重构 Gemini 服务

  - 拆分流式和非流式请求方法
  - 实现非流式请求的内容提取（从 candidates）
  - 实现流式请求的 SSE 解析
  - 添加首字节时间（TTFB）记录
  - _验证需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 4.1 为 Gemini 服务编写单元测试






  - 测试非流式请求
  - 测试流式请求
  - 测试错误处理
  - 测试超时处理
  - _验证需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 4.2 为 Gemini 服务编写属性测试






  - **属性 1: 流式响应完整性**
  - **验证需求: 3.3**

- [x] 5. 更新 AIRequestService 类

  - 更新 execute 方法以处理新的响应格式
  - 添加 requestType 字段到返回对象
  - 添加 ttfb 字段到返回对象（流式请求）
  - 确保统一的响应格式
  - _验证需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 5.1 为 AIRequestService 编写属性测试

  - **属性 2: 响应时间一致性**
  - **属性 4: 统一响应格式**
  - **验证需求: 4.1, 4.2, 4.3, 4.4**

- [x] 6. 增强错误处理

  - 实现网络错误的详细分类
  - 实现 API 错误的消息提取
  - 实现流中断的部分内容保存
  - 添加超时错误的明确提示
  - _验证需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 6.1 为错误处理编写单元测试






  - 测试超时错误
  - 测试 4xx 错误
  - 测试 5xx 错误
  - 测试流中断错误
  - _验证需求: 5.1, 5.2, 5.3, 5.4_



- [x] 6.2 为错误处理编写属性测试




  - **属性 3: 错误处理完整性**
  - **验证需求: 5.1, 5.2, 5.3**

- [x] 7. 更新日志记录


  - 在请求日志中添加 requestType 字段
  - 在流式请求日志中添加 ttfb 字段
  - 区分流式和非流式请求的性能指标
  - 优化日志输出格式
  - _验证需求: 6.1, 6.2, 6.3, 6.4_

- [x] 8. 更新测试配置和文档


  - 更新 README.md 说明流式和非流式的区别
  - 添加流式请求的使用示例
  - 更新 API 文档（Swagger）
  - 添加性能对比说明
  - _验证需求: 所有需求_

- [x] 9. 检查点 - 确保所有测试通过



  - 运行所有单元测试
  - 运行所有属性测试
  - 验证三个提供商的流式和非流式请求
  - 检查日志输出是否正确

- [ ]* 10. 集成测试（可选）
  - 使用真实 API 密钥测试 OpenAI
  - 使用真实 API 密钥测试 Claude
  - 使用真实 API 密钥测试 Gemini
  - 验证端到端测压流程
  - _验证需求: 所有需求_

## 实施说明

### 关键点

1. **SSE 解析是核心**
   - 所有流式请求都依赖正确的 SSE 解析
   - 必须处理不完整的数据行
   - 必须正确识别流结束标记

2. **统一响应格式**
   - 所有服务返回相同的字段结构
   - 便于上层业务逻辑处理
   - 便于未来扩展

3. **错误处理**
   - 流中断时保存已接收的内容
   - 提供详细的错误信息
   - 正确清理资源

4. **性能监控**
   - 记录首字节时间（TTFB）
   - 区分流式和非流式的性能
   - 便于性能分析和优化

### 测试策略

- 单元测试覆盖所有核心逻辑
- 属性测试验证通用属性
- 集成测试验证真实场景（可选，需要 API 密钥）

### 向后兼容性

- 保持 `AIRequestService.execute()` 的接口不变
- 内部实现改进对上层透明
- 现有测压功能不受影响
